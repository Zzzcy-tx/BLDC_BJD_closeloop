/*********************************************************************************************************************
* CH32V203C8T6_BLDC_ESC ï¿½ï¿½ï¿½ï¿½CH32V203C8T6 ï¿½Þ¸ï¿½ï¿½ï¿½Ë¢ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½ï¿½Ú¹Ù·ï¿? SDK ï¿½Ó¿ÚµÄµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô´ï¿½ï¿½Ä¿
* Copyright (c) 2022 SEEKFREE ï¿½ï¿½É¿Æ¼ï¿?
*
* CH32V203C8T6_BLDC_ESC ï¿½ï¿½Ô´ï¿½ï¿½Ä¿ï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½
*
* CH32V203C8T6 ï¿½ï¿½Ô´ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?
* ï¿½ï¿½ï¿½ï¿½ï¿½Ô¸ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½á·?ï¿½ï¿½ï¿½ï¿½ GPLï¿½ï¿½GNU General Public Licenseï¿½ï¿½ï¿½ï¿½ GNUÍ¨ï¿½Ã¹ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö¤ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
* ï¿½ï¿½ GPL ï¿½Äµï¿½3ï¿½æ£¨ï¿½ï¿½ GPL3.0ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ñ¡ï¿½ï¿½Ä£ï¿½ï¿½ÎºÎºï¿½ï¿½ï¿½ï¿½Ä°æ±¾ï¿½ï¿½ï¿½ï¿½ï¿½Â·ï¿½ï¿½ï¿½ï¿½ï¿?/ï¿½ï¿½ï¿½Þ¸ï¿½ï¿½ï¿½
*
* ï¿½ï¿½ï¿½ï¿½Ô´ï¿½ï¿½Ä·ï¿½ï¿½ï¿½ï¿½ï¿½Ï£ï¿½ï¿½ï¿½ï¿½ï¿½Ü·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ã£ï¿½ï¿½ï¿½ï¿½ï¿½Î´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÎºÎµÄ±ï¿½Ö?
* ï¿½ï¿½ï¿½ï¿½Ã»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô»ï¿½ï¿½Êºï¿½ï¿½Ø¶ï¿½ï¿½ï¿½Í¾ï¿½Ä±ï¿½Ö¤
* ï¿½ï¿½ï¿½ï¿½Ï¸ï¿½ï¿½ï¿½ï¿½Î¼ï¿? GPL
*
* ï¿½ï¿½Ó¦ï¿½ï¿½ï¿½ï¿½ï¿½Õµï¿½ï¿½ï¿½ï¿½ï¿½Ô´ï¿½ï¿½ï¿½Í?Ê±ï¿½Õµï¿½Ò»ï¿½ï¿½ GPL ï¿½Ä¸ï¿½ï¿½ï¿½
* ï¿½ï¿½ï¿½Ã»ï¿½Ð£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½<https://www.gnu.org/licenses/>
*
* ï¿½ï¿½ï¿½ï¿½×¢ï¿½ï¿½ï¿½ï¿½
* ï¿½ï¿½ï¿½ï¿½Ô´ï¿½ï¿½Ê¹ï¿½ï¿½ GPL3.0 ï¿½ï¿½Ô´ï¿½ï¿½ï¿½ï¿½Ö¤Ð­ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Îªï¿½ï¿½ï¿½Ä°æ±¾
* ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ó¢ï¿½Ä°ï¿½ï¿½ï¿½ bldc_config/doc ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½Âµï¿½ GPL3_permission_statement.txt ï¿½Ä¼ï¿½ï¿½ï¿½
* ï¿½ï¿½ï¿½ï¿½Ö¤ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ bldc_config ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½Âµï¿½ LICENSE ï¿½Ä¼ï¿½
* ï¿½ï¿½Ó­ï¿½ï¿½Î»Ê¹ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½Þ¸ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ë±£ï¿½ï¿½ï¿½ï¿½É¿Æ¼ï¿½ï¿½Ä°ï¿½È?ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
*
* ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½ï¿½          motor
* ï¿½ï¿½Ë¾ï¿½ï¿½ï¿½ï¿½          ï¿½É¶ï¿½ï¿½ï¿½É¿Æ¼ï¿½ï¿½ï¿½ï¿½Þ¹ï¿½Ë?
* ï¿½æ±¾ï¿½ï¿½Ï¢          ï¿½é¿´ libraries/doc ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½ï¿½ version ï¿½Ä¼ï¿½ ï¿½æ±¾Ëµï¿½ï¿½
* ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½          MounRiver Studio
* ï¿½ï¿½ï¿½ï¿½Æ½Ì¨          CH32V203C8T6
* ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½          https://seekfree.taobao.com/
*
* ï¿½Þ¸Ä¼ï¿½Â¼
* ï¿½ï¿½ï¿½ï¿½            ï¿½ï¿½ï¿½ï¿½         ï¿½ï¿½×¢
* 2024-01-04        ï¿½ï¿½W          first version
********************************************************************************************************************/

#ifndef _motor_h_
#define _motor_h_

#include "headfile.h"
#include "bldc_config.h"

typedef struct
{
    vuint8  run_flag;                       // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð±ï¿½Ö¾Î?
    uint8   step;                           // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÐµÄ²ï¿½ï¿½ï¿?
    uint16  commutation_time[6];            // ï¿½ï¿½ï¿?6ï¿½Î»ï¿½ï¿½ï¿½Ê±ï¿½ï¿½
    int32   duty;                           // PWMÕ¼ï¿½Õ±ï¿½       ï¿½Ã»ï¿½ï¿½Ä±ï¿½ï¿½ï¿½ï¿½Ù¶ï¿½Ê±ï¿½Þ¸Ä´Ë±ï¿½ï¿½ï¿½
    int32   duty_register;                  // PWMÕ¼ï¿½Õ±È¼Ä´ï¿½ï¿½ï¿½ ï¿½Ã»ï¿½ï¿½ï¿½ï¿½É²ï¿½ï¿½ï¿½
    uint32  commutation_faile_count;        // ï¿½ï¿½ï¿½ï¿½Ê§ï¿½Ü¼ï¿½ï¿½ï¿½
    uint32  filter_commutation_time_sum;    // ï¿½Ë²ï¿½ï¿½ï¿½Ä»ï¿½ï¿½ï¿½ï¿½Üºï¿?
    uint32  commutation_time_sum;           // ï¿½ï¿½ï¿?6ï¿½Î»ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½Üºï¿½
    uint32  commutation_num;                // Í³ï¿½Æ»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?
}motor_struct;

struct PID;

typedef enum
{
    MOTOR_IDLE = 0,
    MOTOR_START,
    MOTOR_OPEN_LOOP,
    MOTOR_CLOSE_LOOP ,
    MOTOR_STOP_STALL,
    MOTOR_RESTART,

    BYTE_LOW_VOLTAGE,

}run_state_enum;

#define CLOSE_COMP_PWM    0
#define OPEN_COMP_PWM     1


extern motor_struct motor;

void motor_power_on_beep(uint16 volume);
void motor_start();
void motor_next_step(uint8 comp_pwm);
void motor_stop(uint16 duty);
void motor_commutation_execute(uint8 step, uint8 comp_pwm);

void battery_voltage_init();

#endif
